# Data Model: RAG Retrieval Validation System

## Overview
This document defines the key data structures for the RAG retrieval validation system, based on the entities identified in the feature specification.

## Core Entities

### Query
**Description**: A semantic search request that will be converted to an embedding for similarity search

**Fields**:
- `id` (str): Unique identifier for the query
- `text` (str): The original query text
- `embedding` (List[float]): Vector representation of the query text
- `expected_results` (List[str]): Optional list of expected result IDs for accuracy testing
- `top_k` (int): Number of results to retrieve (default: 5)
- `created_at` (datetime): Timestamp of query creation

**Validation Rules**:
- `text` must not be empty
- `top_k` must be positive integer
- `embedding` must have consistent dimensions with stored vectors

### Content Chunk
**Description**: A segment of book data that has been embedded and stored in Qdrant with associated metadata

**Fields**:
- `id` (str): Unique identifier for the chunk
- `content` (str): The text content of the chunk
- `embedding` (List[float]): Vector representation of the content
- `metadata` (ChunkMetadata): Associated metadata object
- `vector_id` (str): ID used in the vector database
- `created_at` (datetime): Timestamp of chunk creation

**Validation Rules**:
- `content` must not be empty
- `embedding` must have consistent dimensions
- `metadata` must be valid

### ChunkMetadata
**Description**: Information associated with each content chunk including URL, section, chapter, and chunk ID

**Fields**:
- `url` (str): URL where the content originated
- `section` (str): Section title or identifier
- `chapter` (str): Chapter title or identifier
- `chunk_id` (str): Unique identifier for this chunk within the document
- `source_file` (str): Original source file path
- `page_number` (Optional[int]): Page number if applicable

**Validation Rules**:
- `url` must be a valid URL format
- `section`, `chapter`, and `chunk_id` must not be empty
- `page_number` must be positive if provided

### Embedding Vector
**Description**: Numerical representation of text content generated by Cohere models for semantic comparison

**Fields**:
- `vector` (List[float]): The actual numerical vector
- `model_version` (str): Version of the embedding model used
- `dimensions` (int): Number of dimensions in the vector
- `text_hash` (str): Hash of the original text for verification

**Validation Rules**:
- `vector` must have consistent dimensions
- `dimensions` must match expected model output
- `model_version` must be supported

### Validation Result
**Description**: Outcome of testing procedures including accuracy metrics, latency measurements, and compatibility status

**Fields**:
- `id` (str): Unique identifier for the validation result
- `query_id` (str): Reference to the original query
- `retrieved_chunks` (List[ContentChunk]): List of chunks retrieved
- `accuracy_score` (float): Accuracy measurement (0.0 to 1.0)
- `latency_ms` (float): Time taken for retrieval in milliseconds
- `relevance_scores` (List[float]): Individual relevance scores for each retrieved chunk
- `metadata_validation_passed` (bool): Whether metadata validation passed
- `embedding_compatibility_passed` (bool): Whether embedding compatibility validation passed
- `total_retrieved` (int): Total number of chunks retrieved
- `expected_retrieved_count` (int): Number of expected relevant chunks
- `error_message` (Optional[str]): Error message if validation failed
- `timestamp` (datetime): When validation was performed

**Validation Rules**:
- `accuracy_score` must be between 0.0 and 1.0
- `latency_ms` must be non-negative
- `relevance_scores` length must match `retrieved_chunks` length
- `total_retrieved` must be non-negative

## Relationships
- Query → Validation Result (one-to-many)
- Content Chunk → Validation Result (many-to-many through retrieved_chunks)
- ChunkMetadata → Content Chunk (one-to-one)

## State Transitions
- Validation Result: PENDING → COMPLETED | FAILED
- Query: CREATED → PROCESSED → VALIDATED

## Data Validation
All data models include appropriate validation rules to ensure data integrity and consistency across the system. Validation occurs at both input and output boundaries to prevent invalid data from entering the system.